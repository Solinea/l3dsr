# Start a build from Jenkins.
# Jenkins passes in BUILD_OS, BUILD_ARCH, and BUILD_NUMBER.

Package = iptables-daddr

def_make_args = \
	USE_MOCK=1 \
	PLATFORMS='$(BUILD_OS).$(BUILD_ARCH)' \
	BUILD_NUMBER='$(BUILD_NUMBER)'

def_deploy_rpms_args = -f

clean_files =
clobber_files = $(clean_files) \
	$(wildcard results_$(Package)-build-src) \
	$(wildcard results_$(Package)-build-$(BUILD_OS)-$(BUILD_ARCH))
distclean_files = $(clobber_files)

commit-%: BUILD_NUMBER:=$(if $(BUILD_NUMBER),0.$(BUILD_NUMBER))
commit-%: %;
component-%: def_deploy_rpms_args += -R
component-%: %;

all:
	$(MAKE) $(def_make_args) $@

publish: all
	./deploy-rpms \
		$(def_deploy_rpms_args) \
		$(filter-out %.src.rpm,$(wildcard results_$(Package)-build-$(BUILD_OS)-$(BUILD_ARCH)/*.rpm)) \
		$(wildcard results_$(Package)-build-src/*.src.rpm)

clean clobber distclean:
	$(MAKE) $(def_make_args) $@
	$(foreach f,$(wildcard $($@_files)),rm -rf -- '$f'$(nl))

.DEFAULT: commit-all
.PHONY: all publish clean clobber distclean
