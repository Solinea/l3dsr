=== BUILDING ===

These packages supply an Iptables plugin and kernel module and that
allow rewriting of the destination IP address for IPv4 and IPv6.

To build the packages (RPMs) for your OS, type:

    $ make

RPMs will be in:

    $ ls -l build-*/RPMS/* build-*-src/SRPMS


In this release, RHEL4, RHEL5, RHEL6, and Fedora 17 are directly
supported.  If the build fails on another OS, you may need to create
a file in the top level directory called "package-<name>.mk" where
"<name>" is any string you choose to represent its configuration for
make macro overrides.  Using the "package-<name>.mk" should help
avoid the need to change the other files directly.

For RPM-based systems that use yum, the changes are straight-forward.

If your build breaks due to kernel-devel-$(ARCH) dependencies not
being found or other unexpected errors from the rpmbuild, your
native kmodtool utility may be problematic.  Try a version known to
work that's been copied from RHEL5 and RHEL6 (from later releases
with bug fixes).  Use the one from RHEL5 on RHEL4- and RHEL5-like
hosts, and the one from RHEL6 on RHEL6-like and later hosts.  In
your "package-<name>.mk" file for RHEL4, add:
   Kmodtool_native      := $(PWD)/kmodtool.el5
or on RHEL6.0-6.3 and Fedora 17 and later add:
   Kmodtool_native      := $(PWD)/kmodtool.el6

If you're building on an older system or kernel using iptables 1.2
or 1.3, you may need to override by specifying the version in your
"package-<name>.mk" file.  For example, on a RHEL4-like system,
add:
   OSMACRO_native        = rhel_version
   OSMACROVER_native     = 406
   Kmodtool_native      := $(PWD)/kmodtool.el5
   ExtensionsDir_native  = extensions-1.2
   KmodDir_native        = kmod-ipt

or for a RHEL5-like system, add:
   OSMACRO_native        = rhel_version
   OSMACROVER_native     = 505
   ExtensionsDir_native  = extensions-1.3
   KmodDir_native        = kmod-xt-older

If you're building just for some kvariants, you can specify them.
The macro is architecture specific, so for example, on RHEL4/i686
building just for largesmp and Xen:
   KVARIANTS_native.i686   = largesmp xenU
or only just for Xen on RHEL5/x86_64:
   KVARIANTS_native.x86_64 = xen


For systems not using yum and rpm, porting will be more complex.  If
you make changes to port to other systems that can be folded back
into the existing build system, please send me your patchset for
review.


=== USING ===

A practical application of this software is to do L3DSR (Level 3
Direct Server Return).  For an overview, see Jan Schaumann's slides,
l3dsr/docs/nanog51.pdf.

For example, to use iptables-daddr you have two Load Balancers (LBs)
with two VIPs (e.g. 72.30.38.140 and 98.139.183.24) and several
servers behind them.  The LBs must be able to rewrite the DSCP field
of incoming, forwarded packets (or in some way mark the packets such
that an iptables match rule on the servers can identify them).

For example, the first VIP will set the DSCP field to 1 for its
packets going to the servers, where the second VIP will set the
DSCP field to 2.  This will allow the servers to know what to set
the destination address to in reply packets they send directly
to client machines.

On each server, create lookback interfaces corresponding to the VIPs
and iptables rules to set the return address on the packets:
# ifconfig lo:1 72.30.38.140 netmask 255.255.255.255
# ifconfig lo:2 98.139.183.24 netmask 255.255.255.255
# iptables -t mangle -A INPUT -m dscp --dscp 1 -j DADDR --set-daddr=72.30.38.140
# iptables -t mangle -A INPUT -m dscp --dscp 2 -j DADDR --set-daddr=98.139.183.24

An example for IPv6:
# ifconfig lo:3 add fc00:1000:0:6::10/128
# ifconfig lo:4 add fc00:1000:0:6::21/128
# ip6tables -t mangle -A INPUT -m dscp --dscp 10 -j DADDR --set-daddr=fc00:1000:0:6::10
# ip6tables -t mangle -A INPUT -m dscp --dscp 11 -j DADDR --set-daddr=fc00:1000:0:6::21
